# ============================================================================
# TMUX CONFIGURATION
# ============================================================================

# ----------------------------------------------------------------------------
# Core Settings
# ----------------------------------------------------------------------------

# Prefix key configuration
unbind C-b
set-option -g prefix C-s
bind C-s send-prefix

# Terminal and shell configuration
set -ga terminal-overrides ',xterm-256color:Tc:sitm=\E[3m,smxx=\E[9m,xterm-kbs=\177,*:Ss=\E[%p1%d q:Se=\E[1 q'
set -g xterm-keys on
set -g escape-time 10
set-option -g repeat-time 731
set-option -g default-shell /usr/local/bin/fish

# Window and session management
set-option -g renumber-windows on
set -g mouse off

# ----------------------------------------------------------------------------
# Visual Theme
# ----------------------------------------------------------------------------

# Status bar
set -g status on
set -g status-justify right
set -g status-style "fg=#569CD6"
set -g status-right " "
set -g status-left-length 50
set -g status-left " #[fg=#5A5A5A] session:#[fg=#DCDCAA,bg=default] #S"
set -g window-status-format " #[fg=#5A5A5A,bg=default]#I: #[fg=#default,bg=#DCDCAA]#W"
set -g window-status-current-format " #[fg=#DCDCAA,bg=default]#I: #[fg=#5A5A5A,bg=#default]#W"

# Pane styling
set -g pane-border-style "fg=black"
set -g pane-active-border-style "fg=black"
set -g pane-border-lines "single"
set -g window-style "fg=white"

# Copy mode styling
set -g mode-style "fg=white,bg=#363636"

# Popup styling
set -g popup-border-lines rounded
set -g popup-border-style "fg=#545454,bg=default"

# ----------------------------------------------------------------------------
# Key Bindings - Core Navigation
# ----------------------------------------------------------------------------

# Copy mode
bind v copy-mode
# bind -T copy-mode-vi y send-keys -X copy-selection \; send-keys Escape
bind -T copy-mode-vi y send-keys -X copy-pipe "pbcopy" \; send-keys Escape
bind -T copy-mode-vi n send-keys -X next-prompt
bind -T copy-mode-vi p send-keys -X previous-prompt

# Pane navigation (vim-style)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Window navigation
bind -r p next-window
bind -r n previous-window
bind -r N swap-window -t -1 \; select-window -t -1
bind -r M swap-window -t +1 \; select-window -t +1

# Word navigation (Alt/Option key mappings)
bind -n M-Right send-keys M-f  # Forward one word
bind -n M-Left  send-keys M-b  # Backward one word
bind -n M-h send-keys C-w      # Delete previous word

# Note: C-H binding commented to avoid conflict with nvim's :cprev
# bind -n C-H send-keys C-w

# ----------------------------------------------------------------------------
# Key Bindings - Window & Pane Management
# ----------------------------------------------------------------------------

bind c new-window -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind _ split-window -v -l 5 -c "#{pane_current_path}"
bind -r K kill-pane

# ----------------------------------------------------------------------------
# Key Bindings - Utilities
# ----------------------------------------------------------------------------

# Reload configuration
unbind r
bind r source-file ~/.tmux.conf \; display-message " Tmux: source reloaded"

# Clock mode
bind-key T clock-mode

# ----------------------------------------------------------------------------
# Custom Popups - Session & Project Management (Ctrl-Shift-*)
# ----------------------------------------------------------------------------

bind-key -n C-S-v if-shell 'test -n "$TMUX"' \
    'display-popup -w85% -h80% -E -S "fg=#e7e7d3" "$HOME/.local/scripts/tmux-sessionizer-v2-vim.sh"'

bind-key -n C-S-n if-shell 'test -n "$TMUX"' \
    'display-popup -w85% -h80% -E -S "fg=#e7e7d3" "$HOME/.local/scripts/tmux-sessionizer-v2-normal.sh"'

bind-key -n C-S-s if-shell 'test -n "$TMUX"' \
    'display-popup -w85% -h80% -E -S "fg=#e7e7d3" "$HOME/.local/scripts/tmux-fzf-sessions.sh"'

bind-key -T prefix O run-shell '$HOME/.local/scripts/obsidian-tmux-vim.sh'

# ----------------------------------------------------------------------------
# Custom Popups - Shpell Commands (Prefix + Key)
# ----------------------------------------------------------------------------

# Development shell (q)
bind-key -T prefix q run-shell "custom_shpell standard dev"
set -g @shpell-dev-color '#dcdcaa'
set -g @shpell-dev-position 'center'
set -g @shpell-dev-width '84%'
set -g @shpell-dev-height '50%'

# Ephemeral shell (Q)
bind-key -T prefix Q run-shell "custom_shpell ephemeral shell"
set -g @shpell-shell-color '#C6B7EE'
set -g @shpell-shell-position 'right'
set -g @shpell-shell-width '48%'
set -g @shpell-shell-height '60%'

# Claude Code (W)
bind-key -T prefix W run-shell "custom_shpell standard claude 'npx claude'"
set -g @shpell-claude-color '#d77757'
set -g @shpell-claude-position 'right'
set -g @shpell-claude-width '60%'
set -g @shpell-claude-height '100%'

# Git log (G)
bind-key -T prefix G run-shell "custom_shpell ephemeral gitlog \"git log --oneline --graph --decorate --all\""
set -g @shpell-gitlog-color '#e3716e'
set -g @shpell-gitlog-position 'right'
set -g @shpell-gitlog-width '50%'
set -g @shpell-gitlog-height '100%'

# Lazygit (g)
bind-key -T prefix g run-shell "custom_shpell ephemeral lazygit 'lazygit'"
set -g @shpell-lazygit-color '#dcdccd'
set -g @shpell-lazygit-position 'center'
set -g @shpell-lazygit-width '80%'
set -g @shpell-lazygit-height '80%'

# System monitor (t)
bind-key -T prefix t run-shell "custom_shpell ephemeral system-monitor 'btop'"
set -g @shpell-system-monitor-color ''
set -g @shpell-system-monitor-position 'bottom-center'
set -g @shpell-system-monitor-width '80%'
set -g @shpell-system-monitor-height '80%'

# Run command (R)
bind-key -T prefix R run-shell "custom_shpell standard run 'cargo run' --replay"
set -g @shpell-run-color '#de935f'
set -g @shpell-run-position 'center'
set -g @shpell-run-width '80%'
set -g @shpell-run-height '70%'

# Grimoire configuration
set -g @grimoire-title ' 󱥭 '
set -g @grimoire-color '#DDDDCA'
set -g @grimoire-width '84%'
set -g @grimoire-height '50%'
set -g @grimoire-position 'center'

# Build command (commented out)
# bind-key -T prefix B run-shell "custom_shpell standard build 'shpells/smart-build.sh' --replay"

# ----------------------------------------------------------------------------
# Plugin Manager
# ----------------------------------------------------------------------------

run plux
